#!/usr/bin/env Rscript

# Usage: ./deploy [app]; if app is missing, all apps under this directory will
# be deployed; otherwise deploy the app(s) specified. Note the shiny-dev-center
# repository must be under the same directory of this shiny-examples repository.
# Please ask yihui@rstudio.com if you want the credentials for the account
# `demo` on ShinyApps.io.

if (FALSE) {
  devtools::install_github('rstudio/shiny')
  devtools::install_github('rstudio/shinyapps')
}

# first, sync shiny examples
if (file_test('-d', '../shiny/inst/examples')) {
  for (app in list.dirs('../shiny/inst/examples', recursive = FALSE)) {
    dir.create(app1 <- sub('^(\\d\\d)_', '0\\1-', basename(app)), showWarnings = FALSE)
    file.copy(list.files(app, full.names = TRUE), app1, recursive = TRUE)
  }
}

# a font file that is needed for the example 022
if (!file.exists('022-unicode-chinese/wqy-zenhei.ttc'))
  shiny:::download(
    'https://github.com/rstudio/shiny-examples/releases/download/v0.10.1/wqy-zenhei.ttc',
    '022-unicode-chinese/wqy-zenhei.ttc'
  )

# then deploy all apps
library(methods)
library(shinyapps)
# ./deploy 001-hello 002-text ...
apps = commandArgs(TRUE)
# if not specified, use all the directories here
if (length(apps) == 0) {
  apps = list.dirs(full.names = FALSE, recursive = FALSE)
  apps = grep('^[0-9]{3,}', apps, value = TRUE)
}
# print the apps that were not successfully deployed
print(apps[unlist(lapply(apps, function(app) {
  if (inherits(try(deployApp(app, account = 'demo')), 'try-error')) return(1)
  system(paste(
    '../shiny-dev-center/_scripts/import.R',
    app,
    sprintf('http://demo.shinyapps.io/%s', app),
    sprintf('https://github.com/rstudio/shiny-examples/tree/master/%s', app)
  ))
})) != 0])
